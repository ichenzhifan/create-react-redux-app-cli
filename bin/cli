#!/usr/bin/env node

const path = require('path');
const program = require('commander');
const inquirer = require('inquirer');
const { updateFile } = require('../lib/file');
const { install } = require('../lib/install');

const prompt = () => {
  return inquirer.prompt([
    {
      type: 'input',
      name: 'author',
      message: 'è¯·è¾“å…¥ä½œè€…çš„åç§°'
    },
    {
      type: 'input',
      name: 'repository',
      message: 'è¯·è¾“å…¥GitHubçš„é¡¹ç›®åœ°å€'
    },
    {
      type: 'confirm',
      name: 'isOk',
      message: 'è¯·ç¡®è®¤è¾“å…¥æ˜¯å¦ok?'
    }
  ])
};

program
  .version(require('../package.json').version, '-v, --version');

program
  .command('create <ProjectName>')
  .description('åˆ›å»ºä¸€ä¸ªæ–°é¡¹ç›®')
  .action((projectName) => {
    prompt().then(async (results) => {
      console.log(results)
      const { author, repository, isOk } = results;
      if (!isOk) {
        return;
      }

      // 1. cloneé¡¹ç›®
      const { clone } = require('../lib/download');
      console.log('ğŸš€åˆ›å»ºé¡¹ç›®: ' + projectName);
      await clone('github.com:ichenzhifan/react-redux-base', projectName);
      console.log(`é¡¹ç›®${projectName}åˆ›å»ºæˆåŠŸ`);

      // 2. æ›´æ–°package.jsonçš„é…ç½®.
      const packageJson = path.join(path.resolve(projectName), 'package.json');
      const repositoryObj = repository ? {
        type: "git",
        url: repository
      } : {};

      updateFile(packageJson, {
        name: projectName,
        author,
        repository: repositoryObj
      });

      // 3. å®‰è£…ä¾èµ–
      console.log('å®‰è£…ä¾èµ–...')

      // å°†nodeå·¥ä½œç›®å½•æ›´æ”¹æˆæ„å»ºçš„é¡¹ç›®æ ¹ç›®å½•ä¸‹
      const projectPath = path.resolve(projectName);
      process.chdir(projectPath);

      // æ‰§è¡Œå®‰è£…å‘½ä»¤
      install();
    });
  })

program.parse(process.argv);